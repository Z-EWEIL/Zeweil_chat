<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù - ZEWEIL Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { background: #111; color: white; font-family: Tahoma; padding: 20px; }
    h2 { color: #0f0; }
    button { padding: 8px; margin: 5px; border: none; border-radius: 5px; background: #0f0; color: #000; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #333; padding: 10px; text-align: center; }
    th { background: #222; }
    #messagesSection, #usersSection {
      margin-top: 30px;
      border: 1px solid #333;
      padding: 10px;
      max-height: 400px;
      overflow-y: auto;
      background: #222;
    }
    #messagesSection table, #usersSection table {
      width: 100%;
      border-collapse: collapse;
    }
    #messagesSection th, #messagesSection td, 
    #usersSection th, #usersSection td {
      border: 1px solid #444;
      padding: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù - ZEWEIL Chat</h2>
  <button onclick="loadRooms()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù</button>
  <table>
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="roomTable"></tbody>
  </table>

  <div id="messagesSection" style="display:none;">
    <h3>ğŸ“¨ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºØ±ÙØ©: <span id="currentRoomName"></span></h3>
    <table>
      <thead>
        <tr>
          <th>Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„</th>
          <th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>ØªØ¹Ø¯ÙŠÙ„</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="messageTableBody"></tbody>
    </table>
  </div>

  <div id="usersSection" style="display:none;">
    <h3>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©: <span id="currentRoomUsers"></span></h3>
    <table>
      <thead>
        <tr>
          <th>Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±</th>
          <th>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ù†ÙŠØ¯</th>
          <th>ØªØ¨Ù†ÙŠØ¯</th>
          <th>Ø±ÙØ¹ Ø§Ù„ØªØ¨Ù†ÙŠØ¯</th>
        </tr>
      </thead>
      <tbody id="userTableBody"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentRoom = null;

    function loadRooms() {
      const table = document.getElementById("roomTable");
      table.innerHTML = "";
      hideRoomDetails();

      db.ref("rooms").once("value", snapshot => {
        snapshot.forEach(child => {
          const roomName = child.key;
          const room = child.val();

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${roomName}</td>
            <td>${room.active ? "Ù…ÙØªÙˆØ­Ø©" : "Ù…Ù‚ÙÙˆÙ„Ø©"}</td>
            <td>
              <button onclick="toggleRoom('${roomName}', ${room.active})">
                ${room.active ? "ğŸ›‘ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØºØ±ÙØ©" : "âœ… ÙØªØ­ Ø§Ù„ØºØ±ÙØ©"}
              </button>
              <button onclick="sendSystemMessage('${roomName}')">ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…</button>
              <button onclick="deleteRoomMessages('${roomName}')">ğŸ—‘ï¸ Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºØ±ÙØ©</button>
              <button onclick="openRoomDetails('${roomName}')">ğŸ” ÙØªØ­ Ø§Ù„ØºØ±ÙØ©</button>
            </td>
          `;
          table.appendChild(row);
        });
      });
    }

    function toggleRoom(roomName, isActive) {
      db.ref(`rooms/${roomName}`).update({ active: !isActive })
        .then(() => {
          alert(`ØªÙ… ${isActive ? "Ø¥Ù‚ÙØ§Ù„" : "ÙØªØ­"} Ø§Ù„ØºØ±ÙØ©: ${roomName}`);
          loadRooms();
          if(currentRoom === roomName) openRoomDetails(roomName);
        })
        .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ©"));
    }

    function sendSystemMessage(roomName) {
      const message = prompt(`Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¥Ù„Ù‰ ØºØ±ÙØ© "${roomName}":`);
      if (!message) return;

      db.ref(`rooms/${roomName}/messages`).push({
        name: "ğŸš¨ Ø§Ù„Ù†Ø¸Ø§Ù…",
        message: message,
        time: new Date().toLocaleTimeString(),
        system: true
      })
      .then(() => alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­"))
      .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…"));
    }

    function deleteRoomMessages(roomName) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø±Ø³Ø§Ø¦Ù„ ØºØ±ÙØ©: ${roomName}ØŸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!`)) {
        return;
      }
      db.ref(`rooms/${roomName}/messages`).remove()
        .then(() => alert(`âœ… ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø±Ø³Ø§Ø¦Ù„ ØºØ±ÙØ© ${roomName}`))
        .catch(() => alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„"));
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„
    function hideRoomDetails() {
      document.getElementById("messagesSection").style.display = "none";
      document.getElementById("usersSection").style.display = "none";
      currentRoom = null;
    }

    // ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØºØ±ÙØ© (Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ + Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
    function openRoomDetails(roomName) {
      currentRoom = roomName;
      document.getElementById("currentRoomName").textContent = roomName;
      document.getElementById("currentRoomUsers").textContent = roomName;
      document.getElementById("messagesSection").style.display = "block";
      document.getElementById("usersSection").style.display = "block";

      loadRoomMessages(roomName);
      loadRoomUsers(roomName);
    }

    // ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºØ±ÙØ© ÙˆØ¹Ø±Ø¶Ù‡Ø§
    function loadRoomMessages(roomName) {
      const tbody = document.getElementById("messageTableBody");
      tbody.innerHTML = "";

      db.ref(`rooms/${roomName}/messages`).once("value")
        .then(snapshot => {
          snapshot.forEach(child => {
            const key = child.key;
            const msg = child.val();

            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${key}</td>
              <td>${msg.name}</td>
              <td><input type="text" id="msgInput-${key}" value="${msg.message}" style="width: 90%" /></td>
              <td>${msg.time}</td>
              <td><button onclick="editMessage('${key}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button></td>
              <td><button onclick="deleteMessage('${key}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
            `;
            tbody.appendChild(row);
          });
        })
        .catch(() => alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„"));
    }

    function editMessage(msgKey) {
      const newMsg = document.getElementById(`msgInput-${msgKey}`).value.trim();
      if (!newMsg) {
        alert("âŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ©");
        return;
      }
      db.ref(`rooms/${currentRoom}/messages/${msgKey}`).update({ message: newMsg })
        .then(() => {
          alert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
          loadRoomMessages(currentRoom);
        })
        .catch(() => alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"));
    }

    function deleteMessage(msgKey) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) return;
      db.ref(`rooms/${currentRoom}/messages/${msgKey}`).remove()
        .then(() => {
          alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
          loadRoomMessages(currentRoom);
