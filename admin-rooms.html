<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù - ZEWEIL Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { background: #111; color: white; font-family: Tahoma; padding: 20px; }
    h2 { color: #0f0; }
    button { padding: 6px 12px; margin: 5px; border: none; border-radius: 5px; background: #0f0; color: #000; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #333; padding: 10px; text-align: center; vertical-align: middle; }
    th { background: #222; }
    .small-btn { padding: 3px 8px; font-size: 0.9em; }
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      overflow-y: auto;
      padding: 20px;
    }
    .modal-content {
      background: #222; padding: 20px; border-radius: 8px; max-width: 900px; width: 100%;
      color: white;
    }
    .close-btn {
      background: #f00; color: white; float: right; cursor: pointer; border-radius: 50%; width: 28px; height: 28px; font-weight: bold; border: none;
    }
    textarea { width: 100%; height: 60px; background: #111; border: 1px solid #444; color: white; padding: 8px; border-radius: 5px; resize: vertical; }
    input[type="text"], input[type="number"] {
      width: 100px; padding: 6px; border-radius: 5px; border: 1px solid #444; background: #111; color: white; text-align: center;
    }
  </style>
</head>
<body>
  <h2>ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù - ZEWEIL Chat</h2>
  <button onclick="loadRooms()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù</button>
  <table>
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="roomTable"></tbody>
  </table>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù„Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØºØ±ÙØ© -->
  <div id="roomModal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">Ã—</button>
      <h3>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØºØ±ÙØ©: <span id="modalRoomName"></span></h3>
      <h4>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h4>
      <table id="messagesTable" style="margin-bottom:20px;">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø±Ø³Ù„</th>
            <th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h4>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h4>
      <table id="usersTable">
        <thead>
          <tr>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„ØªØ¨Ù†ÙŠØ¯</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAlim9FOvDcMqTJWINoBCHk3k6DNXS-jTo",
    authDomain: "zeweil-chat.firebaseapp.com",
    databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "zeweil-chat",
    storageBucket: "zeweil-chat.appspot.com",
    messagingSenderId: "79843372176",
    appId: "1:79843372176:web:ea511efffae60c2a6cfc15"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function loadRooms() {
    const table = document.getElementById("roomTable");
    table.innerHTML = "";

    db.ref("rooms").once("value", snapshot => {
      snapshot.forEach(child => {
        const roomName = child.key;
        const room = child.val();

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${roomName}</td>
          <td>${room.active ? "Ù…ÙØªÙˆØ­Ø©" : "Ù…Ù‚ÙÙˆÙ„Ø©"}</td>
          <td>
            <button onclick="toggleRoom('${roomName}', ${room.active})">
              ${room.active ? "ğŸ›‘ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØºØ±ÙØ©" : "âœ… ÙØªØ­ Ø§Ù„ØºØ±ÙØ©"}
            </button>
            <button onclick="sendSystemMessage('${roomName}')">ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…</button>
            <button onclick="deleteRoomMessages('${roomName}')">ğŸ—‘ï¸ Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºØ±ÙØ©</button>
            <button onclick="openRoom('${roomName}')">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØºØ±ÙØ©</button>
          </td>
        `;
        table.appendChild(row);
      });
    });
  }

  function toggleRoom(roomName, isActive) {
    db.ref(`rooms/${roomName}`).update({ active: !isActive })
      .then(() => {
        alert(`ØªÙ… ${isActive ? "Ø¥Ù‚ÙØ§Ù„" : "ÙØªØ­"} Ø§Ù„ØºØ±ÙØ©: ${roomName}`);
        loadRooms();
      })
      .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ©"));
  }

  function sendSystemMessage(roomName) {
    const message = prompt(`Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¥Ù„Ù‰ ØºØ±ÙØ© "${roomName}":`);
    if (!message) return;

    db.ref(`rooms/${roomName}/messages`).push({
      name: "ğŸš¨ Ø§Ù„Ù†Ø¸Ø§Ù…",
      message: message,
      time: new Date().toLocaleTimeString(),
      system: true
    })
    .then(() => alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­"))
    .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…"));
  }

  function deleteRoomMessages(roomName) {
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø±Ø³Ø§Ø¦Ù„ ØºØ±ÙØ©: ${roomName}ØŸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!`)) {
      return;
    }
    db.ref(`rooms/${roomName}/messages`).remove()
      .then(() => alert(`âœ… ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø±Ø³Ø§Ø¦Ù„ ØºØ±ÙØ© ${roomName}`))
      .catch(() => alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„"));
  }

  // --------- ÙØªØ­ Ø§Ù„ØºØ±ÙØ© ÙˆØ¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§ØªÙ‡Ø§ ----------
  let currentOpenedRoom = null;

  function openRoom(roomName) {
    currentOpenedRoom = roomName;
    document.getElementById("modalRoomName").textContent = roomName;
    document.getElementById("roomModal").style.display = "flex";

    loadRoomMessages(roomName);
    loadRoomUsers(roomName);
  }

  function closeModal() {
    document.getElementById("roomModal").style.display = "none";
    currentOpenedRoom = null;
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„ØºØ±ÙØ© ÙˆØ¹Ø±Ø¶Ù‡Ø§
  function loadRoomMessages(roomName) {
    const tbody = document.querySelector("#messagesTable tbody");
    tbody.innerHTML = "";

    db.ref(`rooms/${roomName}/messages`).once("value", snapshot => {
      snapshot.forEach(child => {
        const msgKey = child.key;
        const msg = child.val();

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${msg.name || "Ù…Ø¬Ù‡ÙˆÙ„"}</td>
          <td><textarea id="msgText_${msgKey}" readonly>${msg.message}</textarea></td>
          <td>${msg.time || ""}</td>
          <td>
            <button class="small-btn" onclick="editMessage('${msgKey}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="small-btn" onclick="deleteMessage('${msgKey}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„ØºØ±ÙØ©
  function editMessage(msgKey) {
    const textarea = document.getElementById(`msgText_${msgKey}`);
    if (!textarea.readOnly) {
      // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      const newText = textarea.value.trim();
      if (!newText) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©.");

      db.ref(`rooms/${currentOpenedRoom}/messages/${msgKey}`).update({ message: newText })
        .then(() => {
          textarea.readOnly = true;
          alert("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.");
        })
        .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©."));
    } else {
      // ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      textarea.readOnly = false;
      textarea.focus();
    }
  }

  // Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„ØºØ±ÙØ©
  function deleteMessage(msgKey) {
    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) return;
    db.ref(`rooms/${currentOpenedRoom}/messages/${msgKey}`).remove()
      .then(() => {
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.");
        loadRoomMessages(currentOpenedRoom);
      })
      .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©."));
  }

  // ------- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ© -------
  function loadRoomUsers(roomName) {
    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "";

    db.ref(`rooms/${roomName}/users`).once("value", snapshot => {
      snapshot.forEach(child => {
        const userId = child.key;
        const user = child.val();

        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ù†ÙŠØ¯
        let bannedUntil = user.bannedUntil || 0;
        const now = Date.now();
        let banStatus = "ØºÙŠØ± Ù…Ø¨Ù†Ø¯";
        if (bannedUntil === -1) banStatus = "Ù…Ø¨Ù†Ø¯ Ø¯Ø§Ø¦Ù…Ù‹Ø§";
        else if (bannedUntil > now) {
          const remainingMs = bannedUntil - now;
          const remainingMin = Math.floor(remainingMs / 60000);
          banStatus = `Ù…Ø¨Ù†Ø¯ Ù„Ù…Ø¯Ø© ${remainingMin} Ø¯Ù‚ÙŠÙ‚Ø©`;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${user.name || userId}</td>
          <td>${user.online ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„"}</td>
          <td>${banStatus}</td>
          <td>
            <button class="small-btn" onclick="banUser('${roomName}', '${userId}')">ØªØ¨Ù†ÙŠØ¯</button>
            <button class="small-btn" onclick="unbanUser('${roomName}', '${userId}')">Ø±ÙØ¹ Ø§Ù„ØªØ¨Ù†ÙŠØ¯</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });
  }

  // ØªØ¨Ù†ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  function banUser(roomName, userId) {
    let duration = prompt("Ø§Ø¯Ø®Ù„ Ù…Ø¯Ø© Ø§Ù„ØªØ¨Ù†ÙŠØ¯ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (0 = ØªØ¨Ù†ÙŠØ¯ Ø¯Ø§Ø¦Ù…):", "60");
    if (duration === null) return;

    duration = parseInt(duration);
    if (isNaN(duration) || duration < 0) {
      alert("Ù…Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      return;
    }

    let bannedUntil;
    if (duration === 0) bannedUntil = -1; // ØªØ¨Ù†ÙŠØ¯ Ø¯Ø§Ø¦Ù…
    else bannedUntil = Date.now() + duration * 60000;

    db.ref(`rooms/${roomName}/users/${userId}`).update({ bannedUntil })
      .then(() => {
        alert(`ØªÙ… ØªØ¨Ù†ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø¯Ø© ${duration === 0 ? "Ø¯Ø§Ø¦Ù…Ù‹Ø§" : duration + " Ø¯Ù‚ÙŠÙ‚Ø©"}.`);
        loadRoomUsers(roomName);
      })
      .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¨Ù†ÙŠØ¯."));
  }

  // Ø±ÙØ¹ Ø§Ù„ØªØ¨Ù†ÙŠØ¯
  function unbanUser(roomName, userId) {
    db.ref(`rooms/${roomName}/users/${userId}`).update({ bannedUntil: 0 })
      .then(() => {
        alert("ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ¨Ù†ÙŠØ¯.");
        loadRoomUsers(roomName);
      })
      .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØªØ¨Ù†ÙŠØ¯."));
  }

</script>
</body>
</html>
