<!DOCTYPE html>
<html>
<head>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <input type="text" id="username" placeholder="اكتب اسمك">
  <input type="text" id="room" placeholder="كود الروم">
  <button onclick="joinRoom()">ادخل الروم</button>

  <script>
    const firebaseConfig = {
      databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentRoom = "";
    let currentUser = "";
    let userId = null;
    let userRef = null;

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function joinRoom() {
      const room = document.getElementById("room").value.trim();
      const name = document.getElementById("username").value.trim();
      if (!room || !name) return;

      currentRoom = room;
      currentUser = name;

      const usersRef = db.ref(`rooms/${room}/users`);
      usersRef.once("value", snapshot => {
        let found = false;

        snapshot.forEach(child => {
          const user = child.val();
          if (user.name === name) {
            userId = child.key;
            found = true;
          }
        });

        if (!found) {
          userId = generateUUID();
        }

        // حفظ الـ ID الجديد في localStorage عشان يفضل ثابت لو ممكن
        try {
          localStorage.setItem("userId", userId);
        } catch (e) {}

        userRef = db.ref(`rooms/${room}/users/${userId}`);
        userRef.set({
          name: name,
          online: true,
          lastSeen: Date.now(),
          points: 0
        });

        userRef.onDisconnect().update({ online: false, lastSeen: firebase.database.ServerValue.TIMESTAMP });

        // تخزين معلومات الدخول
        localStorage.setItem("userName", name);
        localStorage.setItem("roomCode", room);

        alert("دخلت الروم بنجاح ✅");
        // ممكن تكمّل هنا بكود عرض الرسائل أو غيره
      });
    }
  </script>
</body>
</html>
