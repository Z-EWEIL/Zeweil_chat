<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ZEWEIL Private Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <style>
    body { background-color: #111; color: white; font-family: Tahoma; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    h2 { color: #0f0; margin-bottom: 10px; }
    #chat-box { width: 90%; max-width: 600px; height: 400px; overflow-y: auto; background: #1a1a1a; border-radius: 10px; padding: 15px; margin: 15px 0; display: flex; flex-direction: column; }
    .message { max-width: 80%; padding: 10px 15px; margin: 8px 0; border-radius: 15px; position: relative; word-wrap: break-word; line-height: 1.4; }
    .my-message { background-color: #0f0; color: #000; align-self: flex-end; border-bottom-right-radius: 0; }
    .other-message { background-color: #333; color: #fff; align-self: flex-start; border-bottom-left-radius: 0; }
    .sender { font-weight: bold; font-size: 0.85em; display: inline-flex; align-items: center; gap: 6px; }
    .time { font-size: 0.75em; opacity: 0.7; margin-top: 4px; text-align: right; }
    .system-message { color: #888; font-style: italic; text-align: center; }
    input, button { padding: 10px; border: none; border-radius: 5px; margin: 5px; }
    input { width: 60%; }
    #room { width: 200px; margin-bottom: 10px; }
    button { background-color: #0f0; color: black; cursor: pointer; }

    /* صورة البادج الصغيرة */
    .rank-badge-img {
      width: 16px;
      height: 16px;
      vertical-align: middle;
      margin-left: 5px;
      border-radius: 3px;
      object-fit: contain;
    }

    #onlineToggle { position: absolute; left: 15px; top: 15px; background: #0f0; color: #000; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #onlineList { position: absolute; left: 15px; top: 65px; background: #222; color: white; padding: 10px; border-radius: 8px; display: none; max-height: 300px; overflow-y: auto; min-width: 200px; }
    #giftShop { margin: 10px 0; }
    .reactions { margin-top: 6px; display: flex; gap: 8px; flex-wrap: wrap; }
    .reaction { background: #0f0; color: #000; padding: 2px 6px; border-radius: 10px; font-size: 0.85em; cursor: pointer; user-select: none; }
    .emoji-picker {
      position: fixed;
      background: #222;
      border: 1px solid #0f0;
      border-radius: 6px;
      padding: 5px;
      display: flex;
      gap: 6px;
      z-index: 1000;
    }
    .emoji-picker span {
      cursor: pointer;
      font-size: 1.3em;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="onlineToggle">👥</div>
  <div id="onlineList"></div>
  <h2>🔐 دردشة ZEWEIL الخاصة</h2>
  <input type="text" id="room" placeholder="🛡️ كود الغرفة" />
  <input type="text" id="username" placeholder="🡩‍💬 اسمك" />
  <button onclick="joinRoom()">انضم</button>
  <div id="giftShop">
    <button onclick="window.open('https://app.fawaterk.com/paymentRequest/show/25451', '_blank')">🎁 شراء نقاط</button>
    <span id="pointsDisplay">رصيدك: 0 🎯</span>
  </div>
  <div id="chat-box"></div>
  <input type="text" id="message" placeholder="💬 رسالتك" />
  <button onclick="sendMessage()">إرسال</button>
  <button onclick="startCall()">📹 مكالمة فيديو</button>
  <button onclick="startVoiceCall()">📞 مكالمة صوتية</button>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAlim9FOvDcMqTJWINoBCHk3k6DNXS-jTo",
    authDomain: "zeweil-chat.firebaseapp.com",
    databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "zeweil-chat",
    storageBucket: "zeweil-chat.appspot.com",
    messagingSenderId: "79843372176",
    appId: "1:79843372176:web:ea511efffae60c2a6cfc15"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentRoom = "";
  let currentUser = "";
  let userId = localStorage.getItem("savedUserId") || null;
  let userRef = null;

  const userRanksCache = {}; // كاش للرُتب حسب userId

  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      localStorage.setItem("savedUserId", userId);
      // إذا كان المستخدم مسجل فعلاً، استرجع اسمه المحفوظ
      if (!localStorage.getItem("userName")) {
        promptForName();
      } else {
        document.getElementById("username").value = localStorage.getItem("userName");
      }
    } else {
      firebase.auth().signInAnonymously().catch(error => {
        console.error("Auth error:", error.message);
      });
    }
  });

  function promptForName() {
    let name = prompt("من فضلك أدخل اسمك:");
    if (name && name.trim().length > 0) {
      name = name.trim();
      localStorage.setItem("userName", name);
      document.getElementById("username").value = name;
    }
  }

  const giftPrices = { '🌹': 5, '🎉': 10, '💎': 25, '🏆': 50 };

  document.getElementById("onlineToggle").onclick = () => {
    const list = document.getElementById("onlineList");
    list.style.display = list.style.display === "block" ? "none" : "block";
  };

  // جلب رتبة المستخدم من قاعدة البيانات مع كاش
  async function getUserRank(uid) {
    if (userRanksCache[uid]) return userRanksCache[uid];
    const snap = await db.ref(`users/${uid}/rank`).once("value");
    const rank = snap.val() || "";
    userRanksCache[uid] = rank;
    return rank;
  }

  // دالة ترجع صورة البادج حسب الرتبة (صور يجب رفعها في نفس مسار الريبو)
  function getRankBadge(rank) {
    if (!rank) return "";
    const badgeMap = {
      "مبتدئ": "mobtade.png",
      "متوسط": "motaset.png",
      "خبير": "khabir.png",
      "محترف": "mohtarif.png",
      "بروفشينال": "professional.png",
      "Z": "z.png"
    };
    const src = badgeMap[rank];
    if (!src) return "";
    return `<img src="${src}" alt="${rank}" class="rank-badge-img" />`;
  }

  async function sendMessage() {
    const msg = document.getElementById("message").value.trim();
    if (!currentRoom || !currentUser || !msg) return;
    await db.ref(`rooms/${currentRoom}/messages`).push({
      name: currentUser,
      userId: userId,
      message: msg,
      time: new Date().toLocaleTimeString(),
      reactions: {}
    });
    document.getElementById("message").value = "";
  }

  async function joinRoom() {
    const room = document.getElementById("room").value.trim();
    const name = document.getElementById("username").value.trim();
    if (!room || !name || !userId) {
      alert("الرجاء إدخال كود الغرفة واسمك أولاً");
      return;
    }

    currentRoom = room;
    currentUser = name;
    userRef = db.ref(`rooms/${room}/users/${userId}`);
    const now = Date.now();

    // تحديث بيانات المستخدم العامة (أو إضافته إذا جديد)
    const userSnap = await db.ref(`users/${userId}`).once("value");
    if (userSnap.exists()) {
      await db.ref(`users/${userId}`).update({ name: currentUser });
    } else {
      await db.ref(`users/${userId}`).set({ name: currentUser, points: 0, rank: "مبتدئ" });
    }

    // تسجيل دخول المستخدم إلى الغرفة
    await userRef.set({ name: currentUser, online: true, lastSeen: now });
    userRef.onDisconnect().update({ online: false, lastSeen: firebase.database.ServerValue.TIMESTAMP });

    localStorage.setItem("roomCode", currentRoom);
    localStorage.setItem("userName", currentUser);

    // تنظيف العرض الحالي للدردشة
    db.ref(`rooms/${room}/messages`).off();
    document.getElementById("chat-box").innerHTML = "";

    // استماع للرسائل الجديدة
    db.ref(`rooms/${room}/messages`).on("child_added", async (snapshot) => {
      const data = snapshot.val();
      const key = snapshot.key;
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message");

      if (data.system) {
        msgDiv.classList.add("system-message");
        msgDiv.textContent = data.message;
        document.getElementById("chat-box").appendChild(msgDiv);
        document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
        return;
      }

      msgDiv.classList.add(data.name === currentUser ? "my-message" : "other-message");
      msgDiv.ondblclick = () => showEmojiPicker(msgDiv, key);

      // جلب رتبة المستخدم وإظهار صورة البادج بجانب الاسم
      let rankBadgeHTML = "";
      if (data.userId) {
        const rank = await getUserRank(data.userId);
        rankBadgeHTML = getRankBadge(rank);
      }

      msgDiv.innerHTML = `
        <div class="sender">${data.name} ${rankBadgeHTML}</div>
        ${data.message}
        <div class="time">${data.time}</div>
      `;

      // زر إرسال هدية
      const giftBtn = document.createElement("button");
      giftBtn.textContent = "🎁";
      giftBtn.onclick = () => sendGift(data.name);
      msgDiv.appendChild(giftBtn);

      // عرض ردود الفعل
      const reactionsDiv = document.createElement("div");
      reactionsDiv.className = "reactions";
      if (data.reactions) {
        Object.entries(data.reactions).forEach(([emoji, users]) => {
          if (users.length > 0) {
            const r = document.createElement("div");
            r.className = "reaction";
            r.textContent = `${emoji} ${users.length}`;
            r.onclick = () => addReaction(key, emoji);
            reactionsDiv.appendChild(r);
          }
        });
      }
      msgDiv.appendChild(reactionsDiv);

      document.getElementById("chat-box").appendChild(msgDiv);
      document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
    });

    // تحديث رصيد النقاط بشكل مباشر
    db.ref(`users/${userId}/points`).on("value", snap => {
      document.getElementById("pointsDisplay").textContent = `رصيدك: ${snap.val() || 0} 🎯`;
    });

    // عرض قائمة الأعضاء مع حالة الأونلاين وصورة البادج (الرتبة)
    db.ref(`rooms/${room}/users`).on("value", async (snapshot) => {
      const list = document.getElementById("onlineList");
      list.innerHTML = "<strong>👥 الأعضاء:</strong><br><br>";
      const members = [];
      snapshot.forEach(child => {
        members.push({ id: child.key, data: child.val() });
      });

      for (const member of members) {
        const rank = await getUserRank(member.id);
        const badgeHTML = getRankBadge(rank);
        const name = member.data.name || "مجهول";
        const online = member.data.online;
        const lastSeen = member.data.lastSeen || 0;

        let line = `• ${name} ${badgeHTML} `;
        if (online) {
          line += "🟢";
        } else {
          const diff = Date.now() - lastSeen;
          const minutes = Math.floor(diff / 60000);
          if (minutes < 1) line += "⭕ منذ لحظات";
          else if (minutes < 60) line += `⭕ منذ ${minutes} دقيقة`;
          else line += `⭕ منذ ${Math.floor(minutes / 60)} ساعة`;
        }

        list.innerHTML += line + "<br>";
      }
    });

    // إضافة رسالة نظام انضمام
    await db.ref(`rooms/${currentRoom}/messages`).push({
      name: "🚪 النظام",
      message: `📢 لقد انضم ${currentUser}`,
      time: new Date().toLocaleTimeString(),
      system: true
    });
  }

  function sendGift(toUser) {
    const emoji = prompt("اختر هدية: 🌹 🎉 💎 🏆");
    if (!giftPrices[emoji]) return alert("❌ هدية غير صحيحة");

    const userPointsRef = db.ref(`users/${userId}/points`);
    userPointsRef.once("value", snap => {
      const currentPoints = snap.val() || 0;
      const cost = giftPrices[emoji];
      if (currentPoints < cost) return alert("❌ لا تملك نقاط كافية!");

      userPointsRef.set(currentPoints - cost);

      db.ref("users").once("value", snapshot => {
        snapshot.forEach(child => {
          const data = child.val();
          if (data.name === toUser) {
            const receiverRef = db.ref(`users/${child.key}/points`);
            receiverRef.once("value", snap2 => {
              const receiverPoints = snap2.val() || 0;
              receiverRef.set(receiverPoints + cost);
            });
          }
        });
      });

      db.ref(`rooms/${currentRoom}/messages`).push({
        name: "🎁 هدية",
        message: `${currentUser} أرسل ${emoji} إلى ${toUser}`,
        time: new Date().toLocaleTimeString(),
        system: true
      });
    });
  }

  function addReaction(msgKey, emoji) {
    const ref = db.ref(`rooms/${currentRoom}/messages/${msgKey}/reactions/${emoji}`);
    ref.once("value", snapshot => {
      let users = snapshot.val() || [];
      if (!Array.isArray(users)) users = Object.values(users); // تصحيح إذا كانت بيانات قديمة

      if (users.includes(currentUser)) {
        users = users.filter(u => u !== currentUser);
      } else {
        users.push(currentUser);
      }
      ref.set(users);
    });
  }

  function showEmojiPicker(target, msgKey) {
    if(document.querySelector(".emoji-picker")) document.body.removeChild(document.querySelector(".emoji-picker"));
    let picker = document.createElement("div");
    picker.className = "emoji-picker";
    ["❤️", "😂", "👍", "👎", "😮", "😢"].forEach(e => {
      let span = document.createElement("span");
      span.textContent = e;
      span.onclick = () => {
        addReaction(msgKey, e);
        document.body.removeChild(picker);
      };
      picker.appendChild(span);
    });
    document.body.appendChild(picker);
    const rect = target.getBoundingClientRect();
    picker.style.left = rect.left + "px";
    picker.style.top = (rect.top - 40) + "px";
    picker.style.display = "block";
  }

  function startCall() {
    const room = document.getElementById("room").value.trim();
    if (room) window.open("https://meet.jit.si/" + room, "_blank");
  }

  function startVoiceCall() {
    const room = document.getElementById("room").value.trim();
    if (room) window.open("https://meet.jit.si/" + room + "-voice", "_blank");
  }

  // إشعار عند خروج المستخدم (تحديث الحالة والرسالة في الغرفة)
  window.addEventListener('beforeunload', function () {
    if (!currentRoom || !currentUser || !userRef) return;
    db.ref(`rooms/${currentRoom}/messages`).push({
      name: "🚪 النظام",
      message: `🚪 لقد غادر ${currentUser}`,
