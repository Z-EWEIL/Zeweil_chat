<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ZEWEIL Private Chat</title>
  <!-- روابط Firebase وCSS زي ما عندك -->
  <style>
    /* نفس التنسيق اللي عندك */
  </style>
</head>
<body>
  <div id="onlineToggle">👥</div>
  <div id="onlineList"></div>

  <!-- زر متجر الرتب -->
  <a href="https://zeweil-chat.vercel.app/rank-shop.html" id="shopButton" title="متجر الرتب">🛒</a>

  <h2>🔐 دردشة ZEWEIL الخاصة</h2>
  <input type="text" id="room" placeholder="🛡️ كود الغرفة" />
  <input type="text" id="username" placeholder="🡩‍💬 اسمك" />
  <button onclick="joinRoom()">انضم</button>
  <div id="giftShop">
    <button onclick="window.open('https://app.fawaterk.com/paymentRequest/show/25451', '_blank')">
      🎁 شراء نقاط
    </button>
    <span id="pointsDisplay">رصيدك: 0 🎯</span>
  </div>
  <div id="chat-box"></div>
  <input type="text" id="message" placeholder="💬 رسالتك" />
  <button onclick="sendMessage()">إرسال</button>
  <button onclick="startCall()">📹 مكالمة فيديو</button>
  <button onclick="startVoiceCall()">📞 مكالمة صوتية</button>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAlim9FOvDcMqTJWINoBCHk3k6DNXS-jTo",
      authDomain: "zeweil-chat.firebaseapp.com",
      databaseURL:
        "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "zeweil-chat",
      storageBucket: "zeweil-chat.appspot.com",
      messagingSenderId: "79843372176",
      appId: "1:79843372176:web:ea511efffae60c2a6cfc15",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentRoom = "";
    let currentUser = "";
    let userId = localStorage.getItem("savedUserId") || null;
    let userRef = null;

    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        userId = user.uid;
        localStorage.setItem("savedUserId", userId);
      } else {
        firebase
          .auth()
          .signInAnonymously()
          .catch((error) => {
            console.error("Auth error:", error.message);
          });
      }
    });

    const giftPrices = { "🌹": 5, "🎉": 10, "💎": 25, "🏆": 50 };

    document.getElementById("onlineToggle").onclick = () => {
      const list = document.getElementById("onlineList");
      list.style.display = list.style.display === "block" ? "none" : "block";
    };

    function getRankImg(rank) {
      if (!rank) return "";
      const baseRaw =
        "https://raw.githubusercontent.com/Z-EWEIL/Zeweil_chat/main/";
      const filename = `${rank}.png`;
      return `<img src="${baseRaw}${filename}" alt="${rank}" class="rank-icon" />`;
    }

    function sendMessage() {
      const msg = document.getElementById("message").value.trim();
      if (!currentRoom || !currentUser || !msg) return;
      db.ref("rooms/" + currentRoom + "/messages").push({
        name: currentUser,
        message: msg,
        time: new Date().toLocaleTimeString(),
        reactions: {},
      });
      document.getElementById("message").value = "";
    }

    function joinRoom() {
      const room = document.getElementById("room").value.trim();
      const name = document.getElementById("username").value.trim();
      if (!room || !name || !userId) return;

      currentRoom = room;
      currentUser = name;
      userRef = db.ref(`rooms/${room}/users/${userId}`);
      const now = Date.now();

      db.ref(`users/${userId}`)
        .once("value")
        .then((snapshot) => {
          if (snapshot.exists()) {
            db.ref(`users/${userId}`).update({ name: currentUser });
          } else {
            db.ref(`users/${userId}`).set({ name: currentUser, points: 0 });
          }
        });

      userRef.set({ name: currentUser, online: true, lastSeen: now, rank: "beginner" });
      userRef.onDisconnect().update({
        online: false,
        lastSeen: firebase.database.ServerValue.TIMESTAMP,
      });

      localStorage.setItem("roomCode", currentRoom);
      localStorage.setItem("userName", currentUser);

      db.ref("rooms/" + room + "/messages").off();
      document.getElementById("chat-box").innerHTML = "";

      db.ref("rooms/" + room + "/messages").on("child_added", (snapshot) => {
        const data = snapshot.val();
        const key = snapshot.key;
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message");

        if (data.system) {
          msgDiv.classList.add("system-message");
          msgDiv.textContent = data.message;
          document.getElementById("chat-box").appendChild(msgDiv);
          document.getElementById("chat-box").scrollTop =
            document.getElementById("chat-box").scrollHeight;
          return;
        }

        db.ref(`users`).orderByChild("name").equalTo(data.name).once("value", (snap) => {
          let rank = "beginner";
          snap.forEach((userSnap) => {
            if (userSnap.exists()) {
              rank = userSnap.val().rank || "beginner";
            }
          });

          const rankImg = getRankImg(rank);

          msgDiv.classList.add(data.name === currentUser ? "my-message" : "other-message");
          msgDiv.ondblclick = () => showEmojiPicker(msgDiv, key);

          // إضافة زر حذف إذا صاحب الرسالة هو currentUser
          let deleteButtonHTML = "";
          if (data.name === currentUser) {
            deleteButtonHTML = `<button onclick="deleteMessage('${key}')"
              style="margin-left:10px; background:#f44336; color:white; border:none; border-radius:5px; cursor:pointer;">
              حذف
              </button>`;
          }

          msgDiv.innerHTML = `
            <div class="sender">${data.name} ${rankImg} ${deleteButtonHTML}</div>
            ${data.message}
            <div class="time">${data.time}</div>
          `;

          const giftBtn = document.createElement("button");
          giftBtn.textContent = "🎁";
          giftBtn.onclick = () => sendGift(data.name);
          msgDiv.appendChild(giftBtn);

          const reactionsDiv = document.createElement("div");
          reactionsDiv.className = "reactions";
          if (data.reactions) {
            Object.entries(data.reactions).forEach(([emoji, users]) => {
              if (users.length > 0) {
                const r = document.createElement("div");
                r.className = "reaction";
                r.textContent = `${emoji} ${users.length}`;
                reactionsDiv.appendChild(r);
              }
            });
          }

          msgDiv.appendChild(reactionsDiv);
          document.getElementById("chat-box").appendChild(msgDiv);
          document.getElementById("chat-box").scrollTop =
            document.getElementById("chat-box").scrollHeight;
        });
      });

      db.ref(`users/${userId}/points`).on("value", (snap) => {
        document.getElementById("pointsDisplay").textContent = `رصيدك: ${
          snap.val() || 0
        } 🎯`;
      });

      db.ref(`rooms/${room}/users`).on("value", (snapshot) => {
        const list = document.getElementById("onlineList");
        list.innerHTML = "<strong>👥 الأعضاء:</strong><br><br>";
        snapshot.forEach((child) => {
          const user = child.val();
          const name = user.name || "مجهول";
          const online = user.online;
          const lastSeen = user.lastSeen || 0;
          const rank = user.rank || "beginner";

          let line = `• ${name} ${getRankImg(rank)} `;
          if (online) {
            line += "🟢";
          } else {
            const diff = Date.now() - lastSeen;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) line += "⭕ منذ لحظات";
            else if (minutes < 60) line += `⭕ منذ ${minutes} دقيقة`;
            else line += `⭕ منذ ${Math.floor(minutes / 60)} ساعة`;
          }

          list.innerHTML += `${line}<br>`;
        });
      });

      db.ref("rooms/" + room + "/messages").push({
        name: "🚪 النظام",
        message: `📢 لقد انضم ${name}`,
        time: new Date().toLocaleTimeString(),
        system: true,
      });
    }

    function deleteMessage(msgKey) {
      if (!currentRoom) return;
      // احذف الرسالة من قاعدة البيانات
      db.ref(`rooms/${currentRoom}/messages/${msgKey}`).remove();
    }

    function sendGift(toUser) {
      const emoji = prompt("اختر هدية: 🌹 🎉 💎 🏆");
      if (!giftPrices[emoji]) return alert("❌ هدية غير صحيحة");

      const userPointsRef = db.ref(`users/${userId}/points`);
      userPointsRef.once("value", (snap) => {
        const currentPoints = snap.val() || 0;
        const cost = giftPrices[emoji];
        if (currentPoints < cost) return alert("❌ لا تملك نقاط كافية!");

        userPointsRef.set(currentPoints - cost);

        db.ref("users")
          .once("value")
          .then((snapshot) => {
            snapshot.forEach((child) => {
              const data = child.val();
              if (data.name === toUser) {
                const receiverRef = db.ref(`users/${child.key}/points`);
                receiverRef.once("value", (snap2) => {
                  const receiverPoints = snap2.val() || 0;
                  receiverRef.set(receiverPoints + cost);
                });
              }
            });
          });

        db.ref("rooms/" + currentRoom + "/messages").push({
          name: "🎁 هدية",
          message: `${currentUser} أرسل ${emoji} إلى ${toUser}`,
          time: new Date().toLocaleTimeString(),
          system: true,
        });
      });
    }

    function addReaction(msgKey, emoji) {
      const ref = db.ref(
        `rooms/${currentRoom}/messages/${msgKey}/reactions/${emoji}`
      );
      ref.once("value", (snapshot) => {
        const users = snapshot.val() || [];
        if (users.includes(currentUser)) {
          ref.set(users.filter((u) => u !== currentUser));
        } else {
          ref.set([...users, currentUser]);
        }
      });
    }

    function showEmojiPicker(target, msgKey) {
      let picker = document.createElement("div");
      picker.className = "emoji-picker";
      ["❤️", "😂", "👍", "👎", "😮", "😢"].forEach((e) => {
        let span = document.createElement("span");
        span.textContent = e;
        span.onclick = () => {
          addReaction(msgKey, e);
          document.body.removeChild(picker);
        };
        picker.appendChild(span);
      });
      document.body.appendChild(picker);
      picker.style.left = target.getBoundingClientRect().left + "px";
      picker.style.top = target.getBoundingClientRect().top - 40 + "px";
      picker.style.display = "block";
    }

    function startCall() {
      const room = document.getElementById("room").value.trim();
      if (room) window.open("https://meet.jit.si/" + room, "_blank");
    }

    function startVoiceCall() {
      const room = document.getElementById("room").value.trim();
      if (room) window.open("https://meet.jit.si/" + room + "-voice", "_blank");
    }

    window.addEventListener("beforeunload", function () {
      const roomCode = localStorage.getItem("roomCode");
      const userName = localStorage.getItem("userName");
      if (roomCode && userName && userRef) {
        db.ref("rooms/" + roomCode + "/messages").push({
          name: "🚪 النظام",
          message: `🚪 لقد غادر ${userName}`,
          time: new Date().toLocaleTimeString(),
          system: true,
        });
        userRef.update({
          online: false,
          lastSeen: firebase.database.ServerValue.TIMESTAMP,
        });
      }
    });
  </script>
</body>
</html>
